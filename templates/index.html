<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AuroHear - Hearing Asymmetry Screening</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- App styles -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        window.SUPABASE_URL = "{{ supabase_url }}";
        window.SUPABASE_KEY = "{{ supabase_key }}";
    </script>
</head>
<body>
    <!-- Floating decorative blobs (purely visual) -->
    <div id="floating-bg">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
        <div class="grid-lines"></div>
    </div>

    <main id="main-frame" aria-live="polite">
        <!-- ‚Äî LOGIN / AUTH ‚Äî -->
        <section id="login-screen" class="panel">
            <div class="panel-inner">
                <header class="panel-header">
                    <h1 class="brand">AuroHear</h1>
                    <p class="lead">Professional Hearing Screening</p>
                </header>

                <div class="glass-card">
                    <div class="auth-toggle">
                        <button type="button" id="toggle-signin" class="toggle-btn active">Sign In</button>
                        <button type="button" id="toggle-signup" class="toggle-btn">Sign Up</button>
                    </div>

                    <form id="auth-form" class="login-form" autocomplete="off">
                        <!-- Email/Password always visible -->
                        <div class="field">
                            <label for="email">Email</label>
                            <input type="email" id="email" required placeholder="you@example.com" />
                        </div>
                        <div class="field">
                            <label for="password">Password</label>
                            <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        </div>

                        <!-- Extra fields for Sign Up only -->
                        <div id="signup-fields" class="hidden-fields hidden">
                            <div class="row">
                                <div class="field">
                                    <label for="name">First name</label>
                                    <input type="text" id="name" placeholder="Name" />
                                </div>
                                <div class="field">
                                    <label for="surname">Surname</label>
                                    <input type="text" id="surname" placeholder="Surname" />
                                </div>
                            </div>
                            <div class="row compact">
                                <div class="field radio-group">
                                    <label>Age group</label>
                                    <div class="chips">
                                        <label class="chip"><input type="radio" name="age_group" value="child"> Child</label>
                                        <label class="chip"><input type="radio" name="age_group" value="adult"> Adult</label>
                                        <label class="chip"><input type="radio" name="age_group" value="senior"> Senior</label>
                                    </div>
                                </div>
                                <div class="field radio-group">
                                    <label>Gender</label>
                                    <div class="chips">
                                        <label class="chip small"><input type="radio" name="gender" value="male"> M</label>
                                        <label class="chip small"><input type="radio" name="gender" value="female"> F</label>
                                        <label class="chip small"><input type="radio" name="gender" value="other"> O</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="auth-error" class="error-msg hidden"></div>

                        <div class="cta-row">
                            <button type="submit" id="auth-submit-btn" class="btn primary large">Sign In</button>
                        </div>
                    </form>
                </div>

                <footer class="panel-footer">
                    <small class="muted">Professional demo ‚Äî not a medical diagnosis.</small>
                    <div style="margin-top: 8px;">
                        <button id="bypass-btn" class="btn ghost small" style="opacity: 0.5; font-size: 0.8rem;">Or continue as Guest (Demo)</button>
                    </div>
                    
                    <!-- Team Members Section -->
                    <div class="team-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <h4 class="team-title">Project Team</h4>
                        <div class="team-members">
                            <a href="https://github.com/nishnarudkar" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="team-member-link"
                               aria-label="Nishant Narudkar's GitHub profile">
                                Nishant Narudkar
                            </a>
                            <a href="https://github.com/Metzo64" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="team-member-link"
                               aria-label="Maitreya Pawar's GitHub profile">
                                Maitreya Pawar
                            </a>
                            <a href="https://github.com/Vatsal211005" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="team-member-link"
                               aria-label="Vatsal Parmar's GitHub profile">
                                Vatsal Parmar
                            </a>
                            <a href="https://github.com/Aamir-Sarang31" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="team-member-link"
                               aria-label="Aamir Sarang's GitHub profile">
                                Aamir Sarang
                            </a>
                        </div>
                    </div>
                </footer>
            </div>
        </section>

        <!-- ‚Äî WELCOME ‚Äî -->
        <section id="welcome-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Welcome to AuroHear</h2>
                <p class="lead">A fast, professional screening that highlights hearing asymmetry.</p>
                
                <!-- Onboarding Assistant -->
                <div id="onboarding-assistant" class="onboarding-assistant">
                    <div class="assistant-header">
                        <div class="assistant-icon">üéß</div>
                        <h3>Getting Started Guide</h3>
                        <button id="toggle-assistant" class="btn ghost tiny">Hide Guide</button>
                    </div>
                    
                    <div id="assistant-content" class="assistant-content">
                        <!-- Step Navigation -->
                        <div class="step-navigation">
                            <button class="step-btn active" data-step="purpose">Purpose</button>
                            <button class="step-btn" data-step="setup">Setup</button>
                            <button class="step-btn" data-step="faq">FAQ</button>
                            <button class="step-btn" data-step="prepare">Prepare</button>
                        </div>
                        
                        <!-- Step Content -->
                        <div class="step-content">
                            <!-- Purpose Step -->
                            <div id="step-purpose" class="step-panel active">
                                <h4>What is AuroHear?</h4>
                                <div class="step-info">
                                    <p>AuroHear is a <strong>screening tool</strong> that measures hearing thresholds to detect potential differences between your ears.</p>
                                    
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <span class="info-icon">üîç</span>
                                            <div>
                                                <strong>What it does:</strong>
                                                <p>Measures hearing sensitivity at different frequencies</p>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-icon">‚ö†Ô∏è</span>
                                            <div>
                                                <strong>What it's NOT:</strong>
                                                <p>Not a medical diagnosis or replacement for professional evaluation</p>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-icon">‚è±Ô∏è</span>
                                            <div>
                                                <strong>Duration:</strong>
                                                <p>Approximately 5-10 minutes for complete screening</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="important-note">
                                        <strong>Important:</strong> This is a preliminary screening only. 
                                        Consult a licensed audiologist for comprehensive hearing evaluation.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Setup Step -->
                            <div id="step-setup" class="step-panel">
                                <h4>Environment & Equipment Setup</h4>
                                <div class="step-info">
                                    <div class="setup-checklist">
                                        <div class="checklist-item">
                                            <span class="check-icon">üéß</span>
                                            <div>
                                                <strong>Headphones Required</strong>
                                                <p>Use good quality over-ear or on-ear headphones. Earbuds may not provide accurate results.</p>
                                            </div>
                                        </div>
                                        <div class="checklist-item">
                                            <span class="check-icon">üîá</span>
                                            <div>
                                                <strong>Quiet Environment</strong>
                                                <p>Find a quiet room with minimal background noise. Close windows and doors.</p>
                                            </div>
                                        </div>
                                        <div class="checklist-item">
                                            <span class="check-icon">üí∫</span>
                                            <div>
                                                <strong>Comfortable Position</strong>
                                                <p>Sit comfortably where you can focus without distractions for 5-10 minutes.</p>
                                            </div>
                                        </div>
                                        <div class="checklist-item">
                                            <span class="check-icon">üîä</span>
                                            <div>
                                                <strong>Audio Check</strong>
                                                <p>Ensure your device volume is at a moderate level. You'll calibrate during the test.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- FAQ Step -->
                            <div id="step-faq" class="step-panel">
                                <h4>Frequently Asked Questions</h4>
                                <div class="step-info">
                                    <div class="faq-list">
                                        <div class="faq-item">
                                            <button class="faq-question">Is this test accurate? <span class="faq-toggle">+</span></button>
                                            <div class="faq-answer">
                                                <p>AuroHear provides reliable screening measurements when used properly. However, it's not as precise as clinical audiometry performed by professionals. Results should be interpreted as preliminary screening data.</p>
                                            </div>
                                        </div>
                                        <div class="faq-item">
                                            <button class="faq-question">What if I can't hear some tones? <span class="faq-toggle">+</span></button>
                                            <div class="faq-answer">
                                                <p>This is normal! The test is designed to find your hearing threshold - the softest level you can detect. Not hearing very quiet tones is expected and part of the measurement process.</p>
                                            </div>
                                        </div>
                                        <div class="faq-item">
                                            <button class="faq-question">How should I respond during the test? <span class="faq-toggle">+</span></button>
                                            <div class="faq-answer">
                                                <p>Click "YES" if you hear any tone, even if it's very faint. Click "NO" if you hear nothing at all. Don't worry about being perfect - the test adapts to your responses.</p>
                                            </div>
                                        </div>
                                        <div class="faq-item">
                                            <button class="faq-question">What do the results mean? <span class="faq-toggle">+</span></button>
                                            <div class="faq-answer">
                                                <p>Results show your hearing thresholds and any differences between ears. The system will highlight significant asymmetries, but remember this is screening data that requires professional interpretation.</p>
                                            </div>
                                        </div>
                                        <div class="faq-item">
                                            <button class="faq-question">Is my data private? <span class="faq-toggle">+</span></button>
                                            <div class="faq-answer">
                                                <p>Yes! Guest users' data is not stored. Authenticated users can save results to track changes over time, but all data remains private and secure.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Prepare Step -->
                            <div id="step-prepare" class="step-panel">
                                <h4>Ready to Begin?</h4>
                                <div class="step-info">
                                    <div class="readiness-check">
                                        <h5>Before you start, make sure you have:</h5>
                                        <div class="check-grid">
                                            <label class="check-item">
                                                <input type="checkbox" class="readiness-checkbox">
                                                <span class="checkmark">‚úì</span>
                                                <span>Good quality headphones connected</span>
                                            </label>
                                            <label class="check-item">
                                                <input type="checkbox" class="readiness-checkbox">
                                                <span class="checkmark">‚úì</span>
                                                <span>Quiet environment secured</span>
                                            </label>
                                            <label class="check-item">
                                                <input type="checkbox" class="readiness-checkbox">
                                                <span class="checkmark">‚úì</span>
                                                <span>5-10 minutes of uninterrupted time</span>
                                            </label>
                                            <label class="check-item">
                                                <input type="checkbox" class="readiness-checkbox">
                                                <span class="checkmark">‚úì</span>
                                                <span>Comfortable seating position</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="confidence-booster">
                                        <div class="confidence-message">
                                            <span class="confidence-icon">üòå</span>
                                            <div>
                                                <strong>Relax and take your time</strong>
                                                <p>There are no wrong answers. The test adapts to your hearing, so just respond honestly to what you hear.</p>
                                            </div>
                                        </div>
                                    </div>
                                    

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile info for authenticated users -->
                <div id="user-profile-info" class="auth-only glass-card narrow" style="display: none; margin: 1rem 0;">
                    <div class="profile-summary">
                        <h3 id="profile-name">User Profile</h3>
                        <p id="profile-details" class="muted small"></p>
                    </div>
                    <div class="profile-actions">
                        <button id="view-history-btn" class="btn ghost small">View Test History</button>
                        <button id="edit-profile-btn" class="btn ghost small">Edit Profile</button>
                    </div>
                </div>
                
                <div class="cta-row">
                    <button id="start-btn" class="btn primary large">Start Screening</button>
                </div>
                
                <!-- Different messages for auth vs guest -->
                <div id="guest-message" class="guest-only">
                    <p class="muted">Press SPACE or click to continue</p>
                    <p class="muted small">üí° Sign up to save your test history and track changes over time</p>
                </div>
                
                <div id="auth-message" class="auth-only" style="display: none;">
                    <p class="muted">Your test results will be saved to your profile</p>
                </div>
            </div>
        </section>

        <!-- ‚Äî CONSENT ‚Äî -->
        <section id="consent-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">Important Notice</h2>
                <div class="glass-card narrow">
                    <ul class="bullets">
                        <li>Demo only ‚Äî not clinical diagnosis.</li>
                        <li>Use over good headphones in a quiet room.</li>
                        <li>Consult a licensed audiologist for concerns.</li>
                    </ul>
                    <div class="cta-row">
                        <button id="agree-btn" class="btn success">I understand ‚Äî Continue</button>
                        <button id="back-welcome-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî DEVICE CHECK ‚Äî -->
        <section id="device-check-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Headphone & Channel Check</h2>
                <p class="muted">Click each ear to confirm audio and pan direction.</p>

                <div class="channel-row">
                    <button id="left-ear-btn" class="channel-btn left" aria-label="Play left ear test">
                        <div class="ear-icon">üëÇ</div>
                        <span>Left</span>
                    </button>

                    <div class="channel-status-wrap">
                        <p id="channel-status" class="muted status"></p>
                        <small class="muted">If you can‚Äôt hear one side, check your cable/headphones</small>
                    </div>

                    <button id="right-ear-btn" class="channel-btn right" aria-label="Play right ear test">
                        <div class="ear-icon">üëÇ</div>
                        <span>Right</span>
                    </button>
                </div>

                <div class="audio-diagnostics-section" style="margin: 20px 0; padding: 15px; background: rgba(59,47,47,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #6b5b4b;">Audio Troubleshooting</h4>
                    <p style="margin: 0 0 10px 0; font-size: 12px; color: #8b7b6b;">
                        Having audio issues? Run a quick diagnostic to identify problems.
                    </p>
                    <button id="run-audio-diagnostics-btn" class="btn ghost tiny" onclick="window.runAudioDiagnostics()">
                        üîä Test Audio System
                    </button>
                </div>

                <div class="cta-row">
                    <button id="headphones-ready-btn" class="btn success">Headphones Ready</button>
                    <button id="back-consent-btn" class="btn ghost">Back</button>
                </div>
            </div>
        </section>

        <!-- ‚Äî CALIBRATION ‚Äî -->
        <section id="calibration-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Volume calibration</h2>
                <p class="muted">Play the 1 kHz tone and adjust until comfortable.</p>
                <div class="glass-card narrow">
                    <label class="muted">Volume</label>
                    <div class="range-wrap">
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.2">
                        <button id="play-tone-btn" class="btn primary">Play Tone</button>
                    </div>
                    <div class="cta-row">
                        <button id="volume-set-btn" class="btn success">Volume set ‚Äî Continue</button>
                        <button id="back-device-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî INSTRUCTIONS ‚Äî -->
        <section id="instructions-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">How the test works</h2>
                <div class="glass-card">
                    <ol class="muted steps">
                        <li>Starts at a clearly audible level (~40 dB HL).</li>
                        <li>Heard ‚Üí down 10 dB. Not heard ‚Üí up 5 dB.</li>
                        <li>Threshold = softest level where you respond ‚â•50% of trials.</li>
                    </ol>
                    <div class="cta-row">
                        <button id="start-test-btn" class="btn primary large">Start Test</button>
                        <button id="back-calibration-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî TESTING SCREEN ‚Äî (this is where ears show) -->
        <section id="testing-screen" class="panel hidden">
            <div class="panel-inner">
                <!-- Contextual Guidance Header -->
                <div id="test-guidance" class="test-guidance" role="banner" aria-live="polite">
                    <div class="guidance-content">
                        <div class="guidance-icon" aria-hidden="true">üéØ</div>
                        <div class="guidance-text">
                            <h3 id="guidance-title" class="guidance-title">Getting Ready</h3>
                            <p id="guidance-message" class="guidance-message">Preparing your hearing test...</p>
                        </div>
                        <button id="guidance-help" class="btn ghost tiny" aria-label="Show help information">
                            <span aria-hidden="true">?</span>
                        </button>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="progress-section" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                    <div class="progress-header">
                        <span id="progress-text" class="progress-text">Starting test...</span>
                        <span id="progress-label" class="progress-percentage">0%</span>
                    </div>
                    <div class="progress-container">
                        <progress id="progress-bar" value="0" max="100" aria-describedby="progress-text"></progress>
                        <div class="progress-phases">
                            <span class="phase-marker" data-phase="0">Start</span>
                            <span class="phase-marker" data-phase="25">25%</span>
                            <span class="phase-marker" data-phase="50">50%</span>
                            <span class="phase-marker" data-phase="75">75%</span>
                            <span class="phase-marker" data-phase="100">Done</span>
                        </div>
                    </div>
                </div>

                <!-- Test Stage -->
                <div class="test-stage">
                    <!-- Current Test Information -->
                    <div id="test-context" class="test-context" role="status" aria-live="polite">
                        <div class="context-item">
                            <span class="context-label">Testing:</span>
                            <span id="current-ear" class="context-value">Preparing...</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">Frequency:</span>
                            <span id="current-frequency" class="context-value">--</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">Level:</span>
                            <span id="current-level" class="context-value">--</span>
                        </div>
                    </div>

                    <div class="ears-wrap">
                        <!-- Left ear icon -->
                        <div id="left-ear-icon" class="ear-card ear-left ear-inactive" role="img" aria-label="Left ear">
                            <div class="ear-visual" aria-hidden="true">üëÇ</div>
                            <div class="ear-caption">Left Ear</div>
                            <div class="ear-status" id="left-ear-status" aria-live="polite"></div>
                        </div>

                        <!-- central response / info -->
                        <div class="center-response">
                            <!-- Phase Instructions -->
                            <div id="phase-instructions" class="phase-instructions" role="region" aria-labelledby="instruction-title">
                                <h4 id="instruction-title" class="instruction-title">Listen Carefully</h4>
                                <p id="instruction-text" class="instruction-text">
                                    A tone will play. Click "YES" if you hear it, "NO" if you don't.
                                </p>
                                <div id="instruction-tips" class="instruction-tips">
                                    <div class="tip-item">
                                        <span class="tip-icon" aria-hidden="true">üí°</span>
                                        <span class="tip-text">Even very faint sounds count as "heard"</span>
                                    </div>
                                </div>
                            </div>

                            <div id="response-frame" class="response-frame" role="main">
                                <div id="tone-indicator" class="tone-indicator" aria-live="assertive">
                                    <div class="indicator-icon" aria-hidden="true">üîä</div>
                                    <p id="response-status" class="response-status">Preparing test...</p>
                                </div>
                                <div id="response-buttons" class="response-buttons">
                                    <button id="yes-btn" class="btn success">YES ‚Äî Heard</button>
                                    <button id="no-btn" class="btn danger">NO ‚Äî Didn‚Äôt hear</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right ear icon -->
                        <div id="right-ear-icon" class="ear-card ear-right ear-inactive" role="img" aria-label="Right ear">
                            <div class="ear-visual" aria-hidden="true">üëÇ</div>
                            <div class="ear-caption">Right Ear</div>
                            <div class="ear-status" id="right-ear-status" aria-live="polite"></div>
                        </div>
                    </div>
                </div>

                <!-- Help Panel (Initially Hidden) -->
                <div id="help-panel" class="help-panel hidden" role="dialog" aria-labelledby="help-title" aria-modal="false">
                    <div class="help-content">
                        <h4 id="help-title">Quick Help</h4>
                        <div class="help-sections">
                            <div class="help-section">
                                <h5>How to Respond</h5>
                                <ul>
                                    <li><strong>YES:</strong> Click if you hear any sound, even if very quiet</li>
                                    <li><strong>NO:</strong> Click if you hear absolutely nothing</li>
                                    <li><strong>Unsure:</strong> If you think you might have heard something, click YES</li>
                                </ul>
                            </div>
                            <div class="help-section">
                                <h5>What to Expect</h5>
                                <ul>
                                    <li>Tones will get quieter when you hear them</li>
                                    <li>Tones will get louder when you don't hear them</li>
                                    <li>This is normal - the test finds your hearing threshold</li>
                                </ul>
                            </div>
                        </div>
                        <button id="close-help" class="btn ghost small">Close Help</button>
                    </div>
                </div>

                <!-- Test Controls -->
                <div class="test-controls">
                    <button id="pause-test" class="btn ghost small" aria-label="Pause test">
                        <span aria-hidden="true">‚è∏Ô∏è</span> Pause
                    </button>
                    <button id="exit-test-early" class="btn ghost small" aria-label="Exit test early">
                        <span aria-hidden="true">üö™</span> Exit
                    </button>
                </div>
            </div>
        </section>

        <!-- ‚Äî PROFILE MANAGEMENT ‚Äî -->
        <section id="profile-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">User Profile</h2>
                
                <div class="glass-card">
                    <form id="profile-form">
                        <div class="row">
                            <div class="field">
                                <label for="profile-name-input">First Name</label>
                                <input type="text" id="profile-name-input" placeholder="First Name" />
                            </div>
                            <div class="field">
                                <label for="profile-surname-input">Surname</label>
                                <input type="text" id="profile-surname-input" placeholder="Surname" />
                            </div>
                        </div>
                        
                        <div class="row compact">
                            <div class="field radio-group">
                                <label>Age Group</label>
                                <div class="chips">
                                    <label class="chip"><input type="radio" name="profile_age_group" value="child"> Child</label>
                                    <label class="chip"><input type="radio" name="profile_age_group" value="adult"> Adult</label>
                                    <label class="chip"><input type="radio" name="profile_age_group" value="senior"> Senior</label>
                                </div>
                            </div>
                            <div class="field radio-group">
                                <label>Gender</label>
                                <div class="chips">
                                    <label class="chip small"><input type="radio" name="profile_gender" value="male"> M</label>
                                    <label class="chip small"><input type="radio" name="profile_gender" value="female"> F</label>
                                    <label class="chip small"><input type="radio" name="profile_gender" value="other"> O</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="profile-error" class="error-msg hidden"></div>
                        
                        <div class="cta-row">
                            <button type="submit" id="save-profile-btn" class="btn success">Save Changes</button>
                            <button type="button" id="cancel-profile-btn" class="btn ghost">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- ‚Äî TEST HISTORY ‚Äî -->
        <section id="history-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">Test History</h2>
                
                <!-- History Navigation Tabs -->
                <div class="history-tabs">
                    <button id="tab-list" class="tab-btn active">Session List</button>
                    <button id="tab-audiogram" class="tab-btn">Audiogram Overlay</button>
                </div>
                
                <!-- Session List View -->
                <div id="history-list-view" class="tab-content">
                    <div id="history-content" class="glass-card">
                        <div id="history-loading" class="loading-state">
                            <p class="muted">Loading test history...</p>
                        </div>
                        
                        <div id="history-empty" class="empty-state hidden">
                            <p class="muted">No test history found.</p>
                            <p class="muted small">Complete a hearing test to see your results here.</p>
                        </div>
                        
                        <div id="history-list" class="history-list hidden">
                            <!-- Test history items will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Audiogram Overlay View -->
                <div id="history-audiogram-view" class="tab-content hidden">
                    <div class="glass-card">
                        <div class="audiogram-controls">
                            <div class="control-section">
                                <h4>Select Sessions to Display</h4>
                                <div id="session-toggles" class="session-toggles">
                                    <!-- Session toggle checkboxes will be populated here -->
                                </div>
                            </div>
                            <div class="control-section">
                                <button id="select-all-sessions" class="btn ghost small">Select All</button>
                                <button id="clear-all-sessions" class="btn ghost small">Clear All</button>
                                <button id="show-latest-5" class="btn ghost small">Latest 5</button>
                            </div>
                        </div>
                        
                        <div class="history-audiogram-container">
                            <div class="chart-container">
                                <canvas id="history-audiogram-chart"></canvas>
                            </div>
                        </div>
                        
                        <div id="audiogram-legend" class="audiogram-legend">
                            <!-- Legend will be populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="cta-row">
                    <button id="back-to-welcome-btn" class="btn ghost">Back to Welcome</button>
                </div>
            </div>
        </section>

        <!-- ‚Äî RESULTS ‚Äî -->
        <section id="results-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">Results</h2>
                <p id="status-text" class="muted"></p>
                <p id="reliability-indicator" class="muted"></p>
                <p id="recommendation" class="muted"></p>

                <div class="chart-wrap">
                    <canvas id="audiogram-chart" width="1200" height="400"></canvas>
                </div>

                <div class="table-wrap">
                    <h3 class="subtitle">Numerical Results</h3>
                    <table id="results-table">
                        <thead>
                            <tr><th>Frequency (Hz)</th><th>Left (dB HL)</th><th>Right (dB HL)</th><th>Diff (dB)</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                </div>

                <div class="cta-row">
                    <button id="download-results-btn" class="btn primary">Download PNG</button>
                    <button id="download-pdf-btn" class="btn primary">Download PDF</button>
                    <button id="try-again-btn" class="btn primary">Try Again</button>
                    <button id="exit-btn" class="btn danger">Exit</button>
                </div>

                <!-- Post-Test Feedback Section -->
                <div id="feedback-section" class="feedback-section hidden">
                    <div class="glass-card">
                        <div class="feedback-header">
                            <h3>Help Us Improve</h3>
                            <p class="muted">Your feedback helps us enhance the testing experience (optional)</p>
                        </div>

                        <form id="feedback-form" class="feedback-form">
                            <div class="rating-grid">
                                <div class="rating-item">
                                    <label>Test clarity - Were the instructions clear?</label>
                                    <div class="star-rating" data-rating="test_clarity">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                </div>

                                <div class="rating-item">
                                    <label>Audio comfort - Was the audio comfortable?</label>
                                    <div class="star-rating" data-rating="audio_comfort">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                </div>

                                <div class="rating-item">
                                    <label>Ease of use - How easy was the test to complete?</label>
                                    <div class="star-rating" data-rating="ease_of_use">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                </div>
                            </div>

                            <div class="feedback-text">
                                <label for="suggestions-input">Any suggestions or issues you faced? (optional)</label>
                                <textarea 
                                    id="suggestions-input" 
                                    placeholder="Share any technical issues, suggestions for improvement, or general comments about the testing experience..."
                                    maxlength="1000"
                                    rows="3"></textarea>
                                <div class="char-count">
                                    <span id="char-counter">0</span>/1000 characters
                                </div>
                            </div>

                            <div class="feedback-privacy">
                                <p class="privacy-note">
                                    <span class="privacy-icon">üîí</span>
                                    Your feedback is used only to improve the platform. No medical or personal information is collected.
                                </p>
                            </div>

                            <div class="feedback-actions">
                                <button type="submit" id="submit-feedback-btn" class="btn success">Submit Feedback</button>
                                <button type="button" id="skip-feedback-btn" class="btn ghost">Skip</button>
                            </div>
                        </form>

                        <div id="feedback-success" class="feedback-success hidden">
                            <div class="success-message">
                                <span class="success-icon">‚úì</span>
                                <h4>Thank you for your feedback!</h4>
                                <p>Your input helps us improve the testing experience for everyone.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- A small loader overlay -->
    <div id="loader-overlay" class="hidden" aria-hidden="true">
        <div class="loader">Please wait‚Ä¶</div>
    </div>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- App script -->
    <script src="/static/script.js"></script>
</body>
</html>
