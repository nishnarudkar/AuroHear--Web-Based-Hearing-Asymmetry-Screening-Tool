<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Hearing Asymmetry Screening</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- App styles -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        window.SUPABASE_URL = "{{ supabase_url }}";
        window.SUPABASE_KEY = "{{ supabase_key }}";
    </script>
</head>
<body>
    <!-- Floating decorative blobs (purely visual) -->
    <div id="floating-bg">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
        <div class="grid-lines"></div>
    </div>

    <main id="main-frame" aria-live="polite">
        <!-- ‚Äî LOGIN / AUTH ‚Äî -->
        <section id="login-screen" class="panel">
            <div class="panel-inner">
                <header class="panel-header">
                    <h1 class="brand">AuroHear</h1>
                    <p class="lead">Professional Hearing Screening</p>
                </header>

                <div class="glass-card">
                    <div class="auth-toggle">
                        <button type="button" id="toggle-signin" class="toggle-btn active">Sign In</button>
                        <button type="button" id="toggle-signup" class="toggle-btn">Sign Up</button>
                    </div>

                    <form id="auth-form" class="login-form" autocomplete="off">
                        <!-- Email/Password always visible -->
                        <div class="field">
                            <label for="email">Email</label>
                            <input type="email" id="email" required placeholder="you@example.com" />
                        </div>
                        <div class="field">
                            <label for="password">Password</label>
                            <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        </div>

                        <!-- Extra fields for Sign Up only -->
                        <div id="signup-fields" class="hidden-fields hidden">
                            <div class="row">
                                <div class="field">
                                    <label for="name">First name</label>
                                    <input type="text" id="name" placeholder="Name" />
                                </div>
                                <div class="field">
                                    <label for="surname">Surname</label>
                                    <input type="text" id="surname" placeholder="Surname" />
                                </div>
                            </div>
                            <div class="row compact">
                                <div class="field radio-group">
                                    <label>Age group</label>
                                    <div class="chips">
                                        <label class="chip"><input type="radio" name="age_group" value="child"> Child</label>
                                        <label class="chip"><input type="radio" name="age_group" value="adult"> Adult</label>
                                        <label class="chip"><input type="radio" name="age_group" value="senior"> Senior</label>
                                    </div>
                                </div>
                                <div class="field radio-group">
                                    <label>Gender</label>
                                    <div class="chips">
                                        <label class="chip small"><input type="radio" name="gender" value="male"> M</label>
                                        <label class="chip small"><input type="radio" name="gender" value="female"> F</label>
                                        <label class="chip small"><input type="radio" name="gender" value="other"> O</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="auth-error" class="error-msg hidden"></div>

                        <div class="cta-row">
                            <button type="submit" id="auth-submit-btn" class="btn primary large">Sign In</button>
                        </div>
                    </form>
                </div>

                <footer class="panel-footer">
                    <small class="muted">Professional demo ‚Äî not a medical diagnosis.</small>
                    <div style="margin-top: 8px;">
                        <button id="bypass-btn" class="btn ghost small" style="opacity: 0.5; font-size: 0.8rem;">Or continue as Guest (Demo)</button>
                    </div>
                </footer>
            </div>
        </section>

        <!-- ‚Äî WELCOME ‚Äî -->
        <section id="welcome-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Welcome to AuroHear</h2>
                <p class="lead">A fast, professional screening that highlights hearing asymmetry.</p>
                <div class="cta-row">
                    <button id="start-btn" class="btn primary large">Start Screening</button>
                </div>
                <p class="muted">Press SPACE or click to continue</p>
            </div>
        </section>

        <!-- ‚Äî CONSENT ‚Äî -->
        <section id="consent-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">Important Notice</h2>
                <div class="glass-card narrow">
                    <ul class="bullets">
                        <li>Demo only ‚Äî not clinical diagnosis.</li>
                        <li>Use over good headphones in a quiet room.</li>
                        <li>Consult a licensed audiologist for concerns.</li>
                    </ul>
                    <div class="cta-row">
                        <button id="agree-btn" class="btn success">I understand ‚Äî Continue</button>
                        <button id="back-welcome-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî DEVICE CHECK ‚Äî -->
        <section id="device-check-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Headphone & Channel Check</h2>
                <p class="muted">Click each ear to confirm audio and pan direction.</p>

                <div class="channel-row">
                    <button id="left-ear-btn" class="channel-btn left" aria-label="Play left ear test">
                        <div class="ear-icon">üëÇ</div>
                        <span>Left</span>
                    </button>

                    <div class="channel-status-wrap">
                        <p id="channel-status" class="muted status"></p>
                        <small class="muted">If you can‚Äôt hear one side, check your cable/headphones</small>
                    </div>

                    <button id="right-ear-btn" class="channel-btn right" aria-label="Play right ear test">
                        <div class="ear-icon">üëÇ</div>
                        <span>Right</span>
                    </button>
                </div>

                <div class="cta-row">
                    <button id="headphones-ready-btn" class="btn success">Headphones Ready</button>
                    <button id="back-consent-btn" class="btn ghost">Back</button>
                </div>
            </div>
        </section>

        <!-- ‚Äî CALIBRATION ‚Äî -->
        <section id="calibration-screen" class="panel hidden">
            <div class="panel-inner center">
                <h2 class="title">Volume calibration</h2>
                <p class="muted">Play the 1 kHz tone and adjust until comfortable.</p>
                <div class="glass-card narrow">
                    <label class="muted">Volume</label>
                    <div class="range-wrap">
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3">
                        <button id="play-tone-btn" class="btn primary">Play Tone</button>
                    </div>
                    <div class="cta-row">
                        <button id="volume-set-btn" class="btn success">Volume set ‚Äî Continue</button>
                        <button id="back-device-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî INSTRUCTIONS ‚Äî -->
        <section id="instructions-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">How the test works</h2>
                <div class="glass-card">
                    <ol class="muted steps">
                        <li>Starts at a clearly audible level (~40 dB HL).</li>
                        <li>Heard ‚Üí down 10 dB. Not heard ‚Üí up 5 dB.</li>
                        <li>Threshold = softest level where you respond ‚â•50% of trials.</li>
                    </ol>
                    <div class="cta-row">
                        <button id="start-test-btn" class="btn primary large">Start Test</button>
                        <button id="back-calibration-btn" class="btn ghost">Back</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚Äî TESTING SCREEN ‚Äî (this is where ears show) -->
        <section id="testing-screen" class="panel hidden">
            <div class="panel-inner">
                <div class="top-row">
                    <progress id="progress-bar" value="0" max="100"></progress>
                    <div class="progress-label-wrap">
                        <span id="progress-label">0%</span>
                    </div>
                </div>

                <div class="test-stage">
                    <div class="ears-wrap">
                        <!-- Left ear icon -->
                        <div id="left-ear-icon" class="ear-card ear-left ear-inactive" aria-hidden="false">
                            <div class="ear-visual">üëÇ</div>
                            <div class="ear-caption">Left</div>
                        </div>

                        <!-- central response / info -->
                        <div class="center-response">
                            <div id="status-label" class="muted small">Testing</div>
                            <div id="test-info" class="muted small">Test info</div>

                            <div id="response-frame" class="response-frame">
                                <p id="response-status" class="muted">Preparing test... ‚öôÔ∏è</p>
                                <div id="response-buttons" class="response-buttons">
                                    <button id="yes-btn" class="btn success">YES ‚Äî Heard</button>
                                    <button id="no-btn" class="btn danger">NO ‚Äî Didn‚Äôt hear</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right ear icon -->
                        <div id="right-ear-icon" class="ear-card ear-right ear-inactive" aria-hidden="false">
                            <div class="ear-visual">üëÇ</div>
                            <div class="ear-caption">Right</div>
                        </div>
                    </div>
                </div>

                <div class="cta-row right">
                    <button id="exit-test-early" class="btn ghost">Exit</button>
                </div>
            </div>
        </section>

        <!-- ‚Äî RESULTS ‚Äî -->
        <section id="results-screen" class="panel hidden">
            <div class="panel-inner">
                <h2 class="title">Results</h2>
                <p id="status-text" class="muted"></p>
                <p id="recommendation" class="muted"></p>

                <div class="chart-wrap">
                    <canvas id="audiogram-chart" width="1200" height="400"></canvas>
                </div>

                <div class="table-wrap">
                    <h3 class="subtitle">Numerical Results</h3>
                    <table id="results-table">
                        <thead>
                            <tr><th>Frequency (Hz)</th><th>Left (dB HL)</th><th>Right (dB HL)</th><th>Diff (dB)</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                </div>

                <div class="cta-row">
                    <button id="download-results-btn" class="btn primary">Download PNG</button>
                    <button id="download-pdf-btn" class="btn primary">Download PDF</button>
                    <button id="try-again-btn" class="btn primary">Try Again</button>
                    <button id="exit-btn" class="btn danger">Exit</button>
                </div>
            </div>
        </section>
    </main>

    <!-- A small loader overlay -->
    <div id="loader-overlay" class="hidden" aria-hidden="true">
        <div class="loader">Please wait‚Ä¶</div>
    </div>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- App script -->
    <script src="/static/script.js"></script>
</body>
</html>
